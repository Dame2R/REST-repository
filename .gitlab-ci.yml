stages:
  - deploy-pages
  - deploy-vm

deploy-pages:
  image: node
  stage: deploy-pages
  variables:
    PUBLIC_URL: "/wi-inf-projekt-2-greenbpm"
  cache:
    paths:
      - overview/node_modules/
  script:
    - cd overview
    - npm install
    - CI=false npm run build
    - rm -rf public
    - cp build/index.html build/404.html
    - cd ..
    - mv overview/build public
  artifacts:
    paths:
      - public

deploy-vm:
  variables:
    TAG_LATEST: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:latest
    TAG_COMMIT: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:$CI_COMMIT_SHORT_SHA
  image: alpine:latest
  stage: deploy-vm
  tags:
    - deployment
  script:
    - chmod og= $ID_RSA
    - apk update && apk add openssh-client
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker build -t $TAG_COMMIT -t $TAG_LATEST /wi-inf-projekt-2-greenbpm/overview/Dockerfile"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker container rm -f greenbpm || true"
    - ssh -i $ID_RSA -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker run -d -p 80:80 --name greenbpm $TAG_COMMIT"
  environment:
    name: production
    url: http://vm11.fkc.hft-stuttgart.de
  only:
    - develop